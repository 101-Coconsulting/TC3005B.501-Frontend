---
/**
 * Author: Nicole Dávila Hernández
 * 
 * Description: This is the creation page for a new, single user.
 */

import InputField from '@components/InputField.astro';
import Button from '@components/Button.astro';
import TextHeader from '@components/TextHeader.astro';
import MainLayout from "@layouts/MainLayout.astro";
import ModalWrapper from '@components/ModalWrapper.tsx';

import { getCookie } from "@data/cookies";
import type { UserRole } from "@type/roles";
import { roleLabels } from "@config/role-labels";

const role: UserRole = getCookie("role") as UserRole;
const userName = getCookie("username");
const buttonLabel = roleLabels[role];

const departments = ["Technology Department", "Finance", "HR", "", "Marketing", "Sales", "Operations", "Customer Service", "Legal"];
const costCenters = ["TECH01", "FIN02", "HR03"];
const roles = ["N1", "N2", "Applicant", "Authorizer", "Admin", "AccountsPayable", "TravelAgency"];
---

<MainLayout title="Crear Usuario" data={{ userName, buttonLabel, role }}>
  <div>
    <TextHeader
      title="CREAR NUEVO USUARIO"
      subtitle="Por favor complete todos los campos obligatorios"
    />
    <main class="bg-white rounded-lg shadow-md p-8">
      <form id="userForm" class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <InputField label="Nombre Completo" name="user_name" type="text" required={true} />
          <InputField label="Correo Electrónico" name="email" type="email" required={true} />
          <InputField label="Teléfono" name="phone_number" type="tel" required={true} />
          <InputField label="Workstation" name="workstation" type="text" required={true} />

          <!-- Dropdown for Department -->
          <div>
            <label class="block text-sm font-medium mb-2 text-black">Departamento</label>
            <select name="department_name" required class="w-full px-3 py-2 border border-secondary-300 rounded-md shadow-sm text-sm">
              <option value="" disabled selected>Seleccione un departamento</option>
              {departments.map(dept => <option value={dept}>{dept}</option>)}
            </select>
          </div>

          <!-- Dropdown for Cost Center -->
          <div>
            <label class="block text-sm font-medium mb-2 text-black">Centro de Costos</label>
            <select name="costs_center" required class="w-full px-3 py-2 border border-secondary-300 rounded-md shadow-sm text-sm">
              <option value="" disabled selected>Seleccione un CeCo</option>
              {costCenters.map(cc => <option value={cc}>{cc}</option>)}
            </select>
          </div>

          <!-- Dynamic Role Section -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-black">Roles</label>
            <div id="rolesList" class="space-y-2">
              <div class="flex gap-2">
                <select name="role_name" required class="flex-1 px-3 py-2 border border-secondary-300 rounded-md shadow-sm text-sm">
                  <option value="" disabled selected>Seleccione un rol</option>
                  {roles.map(r => <option value={r}>{r}</option>)}
                </select>
                <button type="button" class="text-warning-400 px-2" onclick="this.parentElement.remove()">✕</button>
              </div>
            </div>
            <button type="button" onclick="addRole()" class="mt-2 text-sm text-primary-400 hover:underline">+ Agregar Rol</button>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-end gap-4 pt-4">
          <ModalWrapper
            client:only="react"
            title="Limpiar formulario"
            message="¿Está seguro de que desea limpiar el formulario?"
            variant="border"
            button_type="secondary"
            modal_type="confirm"
          >
            Limpiar
          </ModalWrapper>
          <ModalWrapper
            client:only="react"
            title="Confirmar creación"
            message="¿Está seguro de que desea crear este usuario?"
            variant="filled"
            button_type="primary"
            modal_type="confirm"
          >
            Crear Usuario
          </ModalWrapper>
        </div>
      </form>
    </main>
  </div>
</MainLayout>

<script is:inline>
  document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const requiredFields = this.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        field.classList.add('border-warning-400');
        isValid = false;
      } else {
        field.classList.remove('border-warning-400');
      }
    });

    if (!isValid) {
      alert('Por favor complete todos los campos requeridos');
      return;
    }

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    // Handle multiple roles
    const roles = [];
    this.querySelectorAll('select[name="role_name"]').forEach(select => {
      if (select.value) roles.push(select.value);
    });
    data.role_name = roles;

    console.log('User created:', data); // For testing

    alert('Usuario creado exitosamente (demo frontend)');
    window.location.href = '/dashboard';
  });

  function addRole() {
    const rolesList = document.getElementById('rolesList');
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `
      <select name="role_name" required class="flex-1 px-3 py-2 border border-secondary-300 rounded-md shadow-sm text-sm">
        <option value="" disabled selected>Seleccione un rol</option>
        ${["N1", "N2", "Admin", "Manager"].map(r => `<option value="${r}">${r}</option>`).join("")}
      </select>
      <button type="button" class="text-warning-400 px-2" onclick="this.parentElement.remove()">✕</button>
    `;
    rolesList.appendChild(div);
  }
</script>

